local Players = game:GetService("Players")
local PlayerGui = Players.LocalPlayer:WaitForChild("PlayerGui")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- åˆ›å»ºè¿œç¨‹äº‹ä»¶ç”¨äºç©å®¶é—´é€šä¿¡
local chatRemoteEvent
if ReplicatedStorage:FindFirstChild("CustomChatRemoteEvent") then
    chatRemoteEvent = ReplicatedStorage:FindFirstChild("CustomChatRemoteEvent")
else
    chatRemoteEvent = Instance.new("RemoteEvent")
    chatRemoteEvent.Name = "CustomChatRemoteEvent"
    chatRemoteEvent.Parent = ReplicatedStorage
end

-- åˆ›å»ºä¸»ç•Œé¢
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "CustomChat"
ScreenGui.Parent = PlayerGui
ScreenGui.ResetOnSpawn = false

-- è·å–Robloxè‡ªå¸¦èŠå¤©æŒ‰é’®çš„ä½ç½®å‚è€ƒ
local function findChatButton()
    local chatGui = PlayerGui:FindFirstChild("Chat")
    if chatGui then
        local frame = chatGui:FindFirstChild("Frame")
        if frame then
            return frame:FindFirstChild("BottomLeftControl")
        end
    end
    return nil
end

-- åˆ›å»ºèŠå¤©æŒ‰é’®å®¹å™¨
local chatButtonContainer = Instance.new("Frame")
chatButtonContainer.Name = "ChatButtonContainer"
chatButtonContainer.BackgroundTransparency = 1
chatButtonContainer.Size = UDim2.new(0, 50, 0, 50)

-- å°è¯•å°†æŒ‰é’®æ”¾åœ¨RobloxèŠå¤©æŒ‰é’®æ—è¾¹
local chatBottomLeft = findChatButton()
if chatBottomLeft then
    chatButtonContainer.Parent = chatBottomLeft.Parent
    chatButtonContainer.LayoutOrder = chatBottomLeft.LayoutOrder + 1
else
    -- å¤‡ç”¨ä½ç½®
    chatButtonContainer.Position = UDim2.new(0, 10, 0, 10)
    chatButtonContainer.Parent = ScreenGui
end

-- åˆ›å»ºèŠå¤©æŒ‰é’®
local chatButton = Instance.new("ImageButton")
chatButton.Name = "ChatButton"
chatButton.Size = UDim2.new(0, 46, 0, 46)
chatButton.Position = UDim2.new(0, 0, 0, 0)
chatButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
chatButton.AutoButtonColor = false
chatButton.Image = "rbxassetid://6233278327" -- èŠå¤©å›¾æ ‡
chatButton.Parent = chatButtonContainer

local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0, 8)
buttonCorner.Parent = chatButton

-- åˆ›å»ºèŠå¤©æ¡†
local chatFrame = Instance.new("Frame")
chatFrame.Name = "ChatFrame"
chatFrame.Size = UDim2.new(0, 400, 0, 300) -- å›ºå®šå°ºå¯¸
chatFrame.Position = UDim2.new(0, 10, 0, 60)
chatFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
chatFrame.BackgroundTransparency = 0.5
chatFrame.Visible = false
chatFrame.Parent = chatButtonContainer

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = chatFrame

-- åˆ›å»ºèŠå¤©æ¶ˆæ¯æ¡†
local messagesScrollingFrame = Instance.new("ScrollingFrame")
messagesScrollingFrame.Name = "Messages"
messagesScrollingFrame.Size = UDim2.new(1, -10, 1, -60)
messagesScrollingFrame.Position = UDim2.new(0, 5, 0, 5)
messagesScrollingFrame.BackgroundTransparency = 1
messagesScrollingFrame.BorderSizePixel = 0
messagesScrollingFrame.ScrollBarThickness = 8
messagesScrollingFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
messagesScrollingFrame.ScrollingDirection = Enum.ScrollingDirection.Y -- åªå…è®¸å‚ç›´æ»šåŠ¨
messagesScrollingFrame.Parent = chatFrame

local messagesLayout = Instance.new("UIListLayout")
messagesLayout.Padding = UDim.new(0, 8)
messagesLayout.SortOrder = Enum.SortOrder.LayoutOrder
messagesLayout.Parent = messagesScrollingFrame

-- åˆ›å»ºè¾“å…¥æ¡†
local inputFrame = Instance.new("Frame")
inputFrame.Name = "InputFrame"
inputFrame.Size = UDim2.new(1, -50, 0, 40)
inputFrame.Position = UDim2.new(0, 5, 1, -50)
inputFrame.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
inputFrame.BackgroundTransparency = 0.3
inputFrame.Parent = chatFrame

local inputCorner = Instance.new("UICorner")
inputCorner.CornerRadius = UDim.new(0, 6)
inputCorner.Parent = inputFrame

local inputBox = Instance.new("TextBox")
inputBox.Name = "InputBox"
inputBox.Size = UDim2.new(1, -10, 1, -4)
inputBox.Position = UDim2.new(0, 5, 0, 2)
inputBox.BackgroundTransparency = 1
inputBox.TextColor3 = Color3.fromRGB(255, 255, 255)
inputBox.Text = ""
inputBox.TextXAlignment = Enum.TextXAlignment.Left
inputBox.PlaceholderText = "è¾“å…¥æ¶ˆæ¯..."
inputBox.TextSize = 16
inputBox.Parent = inputFrame

-- åˆ›å»ºè¡¨æƒ…æŒ‰é’®
local emojiButton = Instance.new("ImageButton")
emojiButton.Name = "EmojiButton"
emojiButton.Size = UDim2.new(0, 40, 0, 40)
emojiButton.Position = UDim2.new(1, -45, 1, -50)
emojiButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
emojiButton.BackgroundTransparency = 0.3
emojiButton.Image = "rbxassetid://6233279655" -- è¡¨æƒ…å›¾æ ‡
emojiButton.Parent = chatFrame

local emojiCorner = Instance.new("UICorner")
emojiCorner.CornerRadius = UDim.new(0, 6)
emojiCorner.Parent = emojiButton

-- åˆ›å»ºè¡¨æƒ…é€‰æ‹©æ¡†
local emojiFrame = Instance.new("Frame")
emojiFrame.Name = "EmojiFrame"
emojiFrame.Size = UDim2.new(0, 240, 0, 120)
emojiFrame.Position = UDim2.new(1, 5, 0, 0)
emojiFrame.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
emojiFrame.BackgroundTransparency = 0.2
emojiFrame.Visible = false
emojiFrame.Parent = emojiButton

local emojiUICorner = Instance.new("UICorner")
emojiUICorner.CornerRadius = UDim.new(0, 8)
emojiUICorner.Parent = emojiFrame

local emojiLayout = Instance.new("UIGridLayout")
emojiLayout.CellSize = UDim2.new(0, 40, 0, 40)
emojiLayout.CellPadding = UDim2.new(0, 5, 0, 5)
emojiLayout.SortOrder = Enum.SortOrder.LayoutOrder
emojiLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
emojiLayout.VerticalAlignment = Enum.VerticalAlignment.Center
emojiLayout.Parent = emojiFrame

-- æ·»åŠ ä¸€äº›è¡¨æƒ…
local emojis = {"ğŸ˜€", "ğŸ˜‚", "ğŸ˜", "ğŸ˜", "ğŸ¤”", "ğŸ‘", "â¤ï¸", "ğŸ”¥", "ğŸ®", "ğŸ˜Š", "ğŸ˜¢", "ğŸ˜¡"}
for _, emoji in pairs(emojis) do
    local emojiBtn = Instance.new("TextButton")
    emojiBtn.Size = UDim2.new(0, 40, 0, 40)
    emojiBtn.BackgroundTransparency = 1
    emojiBtn.Text = emoji
    emojiBtn.TextSize = 20
    emojiBtn.Parent = emojiFrame
end

-- æŒ‰é’®çŠ¶æ€å˜é‡
local chatOpen = false
local emojiOpen = false

-- æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©æ¡†
local function addMessage(sender, message, isEmoji)
    local messageFrame = Instance.new("Frame")
    messageFrame.Size = UDim2.new(1, -10, 0, 0) -- é«˜åº¦è‡ªé€‚åº”
    messageFrame.AutomaticSize = Enum.AutomaticSize.Y
    messageFrame.BackgroundTransparency = 1
    messageFrame.LayoutOrder = #messagesScrollingFrame:GetChildren()
    
    local messageLabel = Instance.new("TextLabel")
    messageLabel.Size = UDim2.new(1, 0, 0, 0)
    messageLabel.AutomaticSize = Enum.AutomaticSize.Y
    messageLabel.BackgroundTransparency = 1
    messageLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    messageLabel.TextXAlignment = Enum.TextXAlignment.Left
    messageLabel.TextYAlignment = Enum.TextYAlignment.Top
    messageLabel.Text = sender .. ": " .. message
    messageLabel.TextSize = 16
    messageLabel.Font = Enum.Font.SourceSans
    messageLabel.TextWrapped = true -- æ–‡æœ¬è‡ªåŠ¨æ¢è¡Œ
    messageLabel.Parent = messageFrame
    
    messageFrame.Parent = messagesScrollingFrame
    
    -- åªæœ‰å½“æ¶ˆæ¯è¶…å‡ºå¯è§†åŒºåŸŸæ—¶æ‰æ»šåŠ¨åˆ°åº•éƒ¨
    if messagesScrollingFrame.CanvasSize.Y.Offset > messagesScrollingFrame.AbsoluteWindowSize.Y then
        -- å»¶è¿Ÿä¸€ç‚¹æ—¶é—´å†æ»šåŠ¨ï¼Œç¡®ä¿UIæ›´æ–°å®Œæˆ
        task.wait(0.05)
        messagesScrollingFrame.CanvasPosition = Vector2.new(0, messagesScrollingFrame.AbsoluteCanvasSize.Y)
    end
end

-- åˆ‡æ¢èŠå¤©æ¡†æ˜¾ç¤º/éšè—
local function toggleChat()
    chatOpen = not chatOpen
    
    -- æ·»åŠ åŠ¨ç”»æ•ˆæœ
    local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    
    if chatOpen then
        chatFrame.Size = UDim2.new(0, 0, 0, 0)
        chatFrame.Visible = true
        local tween = TweenService:Create(chatFrame, tweenInfo, {Size = UDim2.new(0, 400, 0, 300)})
        tween:Play()
    else
        local tween = TweenService:Create(chatFrame, tweenInfo, {Size = UDim2.new(0, 0, 0, 0)})
        tween:Play()
        tween.Completed:Connect(function()
            chatFrame.Visible = false
        end)
        -- åŒæ—¶å…³é—­è¡¨æƒ…æ¡†
        emojiFrame.Visible = false
        emojiOpen = false
    end
end

-- åˆ‡æ¢è¡¨æƒ…æ¡†æ˜¾ç¤º/éšè—
local function toggleEmoji()
    emojiOpen = not emojiOpen
    emojiFrame.Visible = emojiOpen
end

-- å‘é€æ¶ˆæ¯ç»™æ‰€æœ‰ç©å®¶
local function sendMessage(message, isEmoji)
    if message ~= "" then
        -- å‘é€åˆ°æœåŠ¡å™¨ï¼Œè®©å…¶ä»–ç©å®¶ä¹Ÿèƒ½çœ‹åˆ°
        chatRemoteEvent:FireServer(message, isEmoji)
        
        -- æœ¬åœ°ç«‹å³æ˜¾ç¤º
        addMessage(Players.LocalPlayer.Name, message, isEmoji)
        inputBox.Text = ""
    end
end

-- å‘é€è¡¨æƒ…
local function sendEmoji(emoji)
    sendMessage(emoji, true)
    emojiFrame.Visible = false
    emojiOpen = false
end

-- ç›‘å¬æ¥è‡ªå…¶ä»–ç©å®¶çš„æ¶ˆæ¯
chatRemoteEvent.OnClientEvent:Connect(function(playerName, message, isEmoji)
    addMessage(playerName, message, isEmoji)
end)

-- è¿æ¥äº‹ä»¶
chatButton.MouseButton1Click:Connect(toggleChat)
emojiButton.MouseButton1Click:Connect(toggleEmoji)

inputBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        sendMessage(inputBox.Text, false)
    end
end)

-- è¿æ¥è¡¨æƒ…æŒ‰é’®äº‹ä»¶
for _, child in pairs(emojiFrame:GetChildren()) do
    if child:IsA("TextButton") then
        child.MouseButton1Click:Connect(function()
            sendEmoji(child.Text)
        end)
    end
end

-- åˆå§‹æ¶ˆæ¯
addMessage("ç³»ç»Ÿ", "æ¬¢è¿ä½¿ç”¨æ¨¡æ‹ŸèŠå¤©ï¼å¼€å§‹ä¸å…¶ä»–ç©å®¶èŠå¤©å§ï¼")

-- æœåŠ¡å™¨è„šæœ¬ï¼ˆéœ€è¦æ”¾åœ¨ServerScriptServiceä¸­ï¼‰
-- ä»¥ä¸‹æ˜¯æœåŠ¡å™¨ç«¯è„šæœ¬ï¼Œéœ€è¦æ”¾åœ¨ServerScriptServiceä¸­
local serverScript = [[
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local chatRemoteEvent = ReplicatedStorage:WaitForChild("CustomChatRemoteEvent")

chatRemoteEvent.OnServerEvent:Connect(function(player, message, isEmoji)
    -- å¹¿æ’­ç»™æ‰€æœ‰ç©å®¶
    for _, otherPlayer in ipairs(Players:GetPlayers()) do
        chatRemoteEvent:FireClient(otherPlayer, player.Name, message, isEmoji)
    end
end)
]]

-- åˆ›å»ºæœåŠ¡å™¨è„šæœ¬ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
if not game.ServerScriptService:FindFirstChild("CustomChatServer") then
    local serverScriptInstance = Instance.new("Script")
    serverScriptInstance.Name = "CustomChatServer"
    serverScriptInstance.Source = serverScript
    serverScriptInstance.Parent = game.ServerScriptService
end